<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation Results - Phase 2B</title>
    <style>
        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }
        
        .header .sim-id {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: white;
            color: #667eea;
        }
        
        .btn-primary:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Content */
        .content {
            padding: 30px;
        }
        
        /* Metadata Section */
        .metadata {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .metadata h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .metadata-item {
            display: flex;
            flex-direction: column;
        }
        
        .metadata-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .metadata-item value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }
        
        /* Summary Statistics */
        .summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        
        .stat-card.pass {
            border-left-color: #10b981;
        }
        
        .stat-card.fail {
            border-left-color: #ef4444;
        }
        
        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-card.pass .stat-value {
            color: #10b981;
        }
        
        .stat-card.fail .stat-value {
            color: #ef4444;
        }
        
        .stat-card .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        /* Filters */
        .filters {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .filters h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Results Table */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        
        th:hover {
            background: #e5e7eb;
        }
        
        th.sortable::after {
            content: ' ‚áÖ';
            opacity: 0.3;
        }
        
        th.sorted-asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
        }
        
        th.sorted-desc::after {
            content: ' ‚ñº';
            opacity: 1;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        /* Pass/Fail Styling */
        tr.pass {
            background: #f0fdf4;
        }
        
        tr.fail {
            background: #fef2f2;
        }
        
        tr.pass:hover {
            background: #dcfce7;
        }
        
        tr.fail:hover {
            background: #fee2e2;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.pass {
            background: #10b981;
            color: white;
        }
        
        .status-badge.fail {
            background: #ef4444;
            color: white;
        }
        
        /* Spec info tooltip */
        .spec-info {
            margin-top: 10px;
            padding: 12px;
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            border-radius: 4px;
            font-size: 13px;
            color: #92400e;
        }
        
        .spec-info strong {
            display: block;
            margin-bottom: 5px;
            color: #78350f;
        }
        
        /* Measurement error styling */
        .measurement-error {
            color: #9ca3af;
            font-style: italic;
            font-size: 0.9em;
        }
        
        /* Loading & Error States */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .loading::before {
            content: '‚è≥';
            font-size: 48px;
            display: block;
            margin-bottom: 20px;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
            margin: 20px 0;
        }
        
        .error h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .error p {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .error code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #1976d2;
        }
        
        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 28px;
            text-align: center;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .spec-limits-grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        
        .spec-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #1976d2;
        }
        
        .spec-item-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .spec-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .spec-inputs label {
            display: flex;
            flex-direction: column;
            flex: 1;
            font-size: 12px;
            color: #666;
        }
        
        .spec-inputs input {
            margin-top: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-secondary {
            background: #757575;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-secondary:hover {
            background: #616161;
        }
        
        .btn-primary-modal {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .btn-primary-modal:hover {
            background: #1565c0;
        }
        
        .btn-primary-modal:disabled,
        .btn-primary-modal.loading {
            background: #9e9e9e;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Loading spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üìä Simulation Results</h1>
                <div class="sim-id" id="simIdDisplay">Loading...</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="exportCsvBtn" style="display: none;">üíæ Export CSV</button>
                <button class="btn btn-primary" onclick="openSpecLimitsModal()">‚öôÔ∏è Configure Spec Limits</button>
                <a href="/frontend/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
            </div>
        </div>
        
        <div class="content">
            <div id="loadingIndicator" class="loading">
                Loading simulation results...
            </div>
            
            <div id="errorContainer" style="display: none;"></div>
            
            <div id="resultsContainer" style="display: none;">
                <!-- Metadata Section -->
                <div class="metadata">
                    <h2>Supply Conditions</h2>
                    <div class="metadata-grid" id="metadataGrid"></div>
                </div>
                
                <!-- Summary Statistics -->
                <div class="summary">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCorners">0</div>
                        <div class="stat-label">Total PVT Corners</div>
                    </div>
                    <div class="stat-card pass">
                        <div class="stat-value" id="passCount">0</div>
                        <div class="stat-label">Within Spec</div>
                    </div>
                    <div class="stat-card fail">
                        <div class="stat-value" id="failCount">0</div>
                        <div class="stat-label">Out of Spec</div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="filters">
                    <h3>üîç Filters</h3>
                    <div class="spec-info">
                        <strong>‚ÑπÔ∏è Understanding Results:</strong>
                        <strong>Pass/Fail Status:</strong> "Within Spec" means the measured value meets the specification limits (e.g., rwkpull_vih: 1500-2500Œ©).
                        "Out of Spec" means the value violates spec limits.<br>
                        <strong>Measurement Errors:</strong> Values showing "<span class="measurement-error">error</span>" indicate the SPICE measurement failed 
                        (TRIG/TARG condition not met). This is NOT a simulation crash - the corner ran successfully but certain measurements couldn't be extracted.
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Process</label>
                            <select id="processFilter">
                                <option value="">All Processes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Temperature</label>
                            <select id="tempFilter">
                                <option value="">All Temperatures</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Voltage</label>
                            <select id="voltageFilter">
                                <option value="">All Voltages</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Spec Status</label>
                            <select id="statusFilter">
                                <option value="">All Corners</option>
                                <option value="pass">Within Spec</option>
                                <option value="fail">Out of Spec</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Results Table -->
                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr id="tableHeaders"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Spec Limits Configuration Modal -->
    <div id="spec-limits-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Configure Specification Limits</h2>
                <button class="close-btn" onclick="closeSpecLimitsModal()">&times;</button>
            </div>
            
            <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; margin-bottom: 20px; font-size: 13px;">
                ‚ÑπÔ∏è <strong>Info:</strong> Custom spec limits override defaults. Leave fields empty to use defaults. 
                Click "Reset to Defaults" to remove all custom limits.
            </div>
            
            <div id="spec-limits-status"></div>
            
            <div class="spec-limits-grid">
                <div class="spec-item">
                    <div class="spec-item-header">rwkpull_vih - Weak Pull-Up Resistance at VIH (Ohms)</div>
                    <div class="spec-inputs">
                        <label>
                            Min (Œ©)
                            <input type="number" id="rwkpull_vih_min" placeholder="1500">
                        </label>
                        <label>
                            Max (Œ©)
                            <input type="number" id="rwkpull_vih_max" placeholder="2500">
                        </label>
                    </div>
                </div>
                
                <div class="spec-item">
                    <div class="spec-item-header">rwkpull_vil - Weak Pull-Up Resistance at VIL (Ohms)</div>
                    <div class="spec-inputs">
                        <label>
                            Min (Œ©)
                            <input type="number" id="rwkpull_vil_min" placeholder="1500">
                        </label>
                        <label>
                            Max (Œ©)
                            <input type="number" id="rwkpull_vil_max" placeholder="2500">
                        </label>
                    </div>
                </div>
                
                <div class="spec-item">
                    <div class="spec-item-header">rwkpulld_vih - Weak Pull-Down Resistance at VIH (Ohms)</div>
                    <div class="spec-inputs">
                        <label>
                            Min (Œ©)
                            <input type="number" id="rwkpulld_vih_min" placeholder="1500">
                        </label>
                        <label>
                            Max (Œ©)
                            <input type="number" id="rwkpulld_vih_max" placeholder="2500">
                        </label>
                    </div>
                </div>
                
                <div class="spec-item">
                    <div class="spec-item-header">rwkpulld_vil - Weak Pull-Down Resistance at VIL (Ohms)</div>
                    <div class="spec-inputs">
                        <label>
                            Min (Œ©)
                            <input type="number" id="rwkpulld_vil_min" placeholder="1500">
                        </label>
                        <label>
                            Max (Œ©)
                            <input type="number" id="rwkpulld_vil_max" placeholder="2500">
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn-secondary" onclick="resetSpecLimits()">üîÑ Reset to Defaults</button>
                <button class="btn-secondary" onclick="closeSpecLimitsModal()">Cancel</button>
                <button id="save-spec-limits-btn" class="btn-primary-modal" onclick="saveSpecLimits()">üíæ Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let resultsData = null;
        let filteredData = null;
        let sortColumn = null;
        let sortDirection = 'asc';
        
        // Get sim_id from URL query parameter
        function getSimId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('sim_id');
        }
        
        // Load results from API
        async function loadResults() {
            const simId = getSimId();
            
            if (!simId) {
                showError('Missing sim_id parameter', 'Please provide a sim_id in the URL query string.');
                return;
            }
            
            document.getElementById('simIdDisplay').textContent = `Simulation ID: ${simId}`;
            
            try {
                const response = await fetch(`/api/results/${simId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    showError(data.error || 'Failed to load results', data.message || '');
                    return;
                }
                
                // CHECK: Empty results (possible CTH environment issue)
                if (!data.rows || data.rows.length === 0) {
                    showCTHWarning();
                    return;
                }
                
                // CHECK: All rows have no valid measurements
                const validRows = data.rows.filter(row => {
                    return row.values && row.values.some(val => val !== null && val !== undefined && val !== '' && val !== 'error');
                });
                
                if (validRows.length === 0) {
                    showCTHWarning();
                    return;
                }
                
                resultsData = data;
                filteredData = data.rows;
                renderResults();
                
            } catch (error) {
                showError('Network error', error.message);
            }
        }
        
        // Show error message
        function showError(title, message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            const errorDiv = document.getElementById('errorContainer');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div class="error">
                    <h3>${title}</h3>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // Show CTH environment warning
        function showCTHWarning() {
            document.getElementById('loadingIndicator').style.display = 'none';
            const errorDiv = document.getElementById('errorContainer');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; 
                            padding: 30px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h2 style="color: #856404; margin: 0 0 20px 0; font-size: 24px;">
                        ‚ö†Ô∏è No Valid Results Found
                    </h2>
                    <p style="font-size: 16px; line-height: 1.6; color: #333; margin-bottom: 20px;">
                        The simulation completed successfully in NetBatch, but no measurement 
                        data was extracted from the SPICE output files.
                    </p>
                    
                    <div style="background: white; border-left: 4px solid #dc3545; 
                                padding: 20px; margin: 20px 0; border-radius: 6px;">
                        <h3 style="color: #dc3545; margin: 0 0 12px 0; font-size: 18px;">
                            Most Common Cause
                        </h3>
                        <p style="margin: 0; font-size: 15px; line-height: 1.6;">
                            The backend server was <strong>not running in the Cheetah (CTH) environment</strong>. 
                            SPICE simulations require specific tools and licenses only available in the CTH environment.
                        </p>
                    </div>
                    
                    <div style="background: #d1ecf1; border-left: 4px solid #0c5460; 
                                padding: 20px; margin: 20px 0; border-radius: 6px;">
                        <h3 style="color: #0c5460; margin: 0 0 12px 0; font-size: 18px;">
                            Solution Steps
                        </h3>
                        <ol style="margin: 0; padding-left: 20px; line-height: 2;">
                            <li style="font-size: 15px;">
                                Stop the backend server (press <kbd>Ctrl+C</kbd> in the terminal)
                            </li>
                            <li style="font-size: 15px;">
                                Navigate to the automation folder:<br>
                                <code style="display: inline-block; margin-top: 8px; background: #f8f9fa; 
                                            padding: 8px 12px; border-radius: 4px; font-size: 13px; 
                                            color: #d63384; border: 1px solid #dee2e6;">
                                    cd /nfs/site/disks/km6_io_37/users/chinseba/simulation/wkpup/automation
                                </code>
                            </li>
                            <li style="font-size: 15px;">
                                Run the quick start script to enter CTH environment:<br>
                                <code style="display: inline-block; margin-top: 8px; background: #f8f9fa; 
                                            padding: 8px 12px; border-radius: 4px; font-size: 13px; 
                                            color: #d63384; border: 1px solid #dee2e6;">
                                    tcsh quick_start.csh
                                </code>
                            </li>
                            <li style="font-size: 15px;">
                                After the script completes and CTH environment is loaded, launch the server:<br>
                                <code style="display: inline-block; margin-top: 8px; background: #f8f9fa; 
                                            padding: 8px 12px; border-radius: 4px; font-size: 13px; 
                                            color: #d63384; border: 1px solid #dee2e6;">
                                    cd /nfs/site/disks/km6_io_37/users/chinseba/simulation/wkpup/automation &&
                                    bash launch_tornado.sh
                                </code>
                            </li>
                            <li style="font-size: 15px;">
                                Resubmit your simulation
                            </li>
                        </ol>
                    </div>
                    
                    <div style="background: #f8f9fa; border-left: 4px solid #17a2b8; 
                                padding: 15px; margin: 20px 0 0 0; border-radius: 6px;">
                        <h4 style="color: #0c5460; margin: 0 0 8px 0; font-size: 16px;">
                            ‚ÑπÔ∏è Other Possible Causes
                        </h4>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 14px; color: #666;">
                            <li>Missing SPICE model files or incorrect paths</li>
                            <li>Simulation configuration errors (check simulation_log.txt)</li>
                            <li>NetBatch job failures (check job output logs)</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // Render results
        function renderResults() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('exportCsvBtn').style.display = 'inline-block';
            
            // Render metadata
            renderMetadata();
            
            // Render summary statistics
            renderSummary();
            
            // Populate filter dropdowns
            populateFilters();
            
            // Render table
            renderTable();
        }
        
        // Render metadata
        function renderMetadata() {
            const grid = document.getElementById('metadataGrid');
            grid.innerHTML = '';
            
            const metadata = resultsData.metadata || {};
            for (const [key, value] of Object.entries(metadata)) {
                const item = document.createElement('div');
                item.className = 'metadata-item';
                item.innerHTML = `
                    <label>${key}</label>
                    <value>${value}</value>
                `;
                grid.appendChild(item);
            }
        }
        
        // Render summary statistics
        function renderSummary() {
            const summary = resultsData.summary || {total: 0, pass_count: 0, fail_count: 0};
            document.getElementById('totalCorners').textContent = summary.total || 0;
            document.getElementById('passCount').textContent = summary.pass_count || 0;
            document.getElementById('failCount').textContent = summary.fail_count || 0;
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            const rows = resultsData.rows || [];
            const headers = resultsData.headers || [];
            
            // Find column indices
            const processIdx = headers.indexOf('process');
            const tempIdx = headers.indexOf('temp');
            const voltageIdx = headers.indexOf('voltage');
            
            // Extract unique values
            const processes = new Set();
            const temps = new Set();
            const voltages = new Set();
            
            rows.forEach(row => {
                if (processIdx >= 0 && row.values[processIdx]) processes.add(row.values[processIdx]);
                if (tempIdx >= 0 && row.values[tempIdx]) temps.add(row.values[tempIdx]);
                if (voltageIdx >= 0 && row.values[voltageIdx]) voltages.add(row.values[voltageIdx]);
            });
            
            // Populate dropdowns
            populateSelect('processFilter', Array.from(processes).sort());
            populateSelect('tempFilter', Array.from(temps).sort());
            populateSelect('voltageFilter', Array.from(voltages).sort());
        }
        
        // Populate select dropdown
        function populateSelect(id, values) {
            const select = document.getElementById(id);
            const firstOption = select.options[0].text; // Preserve "All" option
            select.innerHTML = `<option value="">${firstOption}</option>`;
            
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
        }
        
        // Apply filters
        function applyFilters() {
            const processFilter = document.getElementById('processFilter').value;
            const tempFilter = document.getElementById('tempFilter').value;
            const voltageFilter = document.getElementById('voltageFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const headers = resultsData.headers || [];
            const processIdx = headers.indexOf('process');
            const tempIdx = headers.indexOf('temp');
            const voltageIdx = headers.indexOf('voltage');
            
            filteredData = (resultsData.rows || []).filter(row => {
                // Process filter
                if (processFilter && row.values[processIdx] !== processFilter) return false;
                
                // Temperature filter
                if (tempFilter && row.values[tempIdx] !== tempFilter) return false;
                
                // Voltage filter
                if (voltageFilter && row.values[voltageIdx] !== voltageFilter) return false;
                
                // Status filter
                if (statusFilter && row.status !== statusFilter) return false;
                
                return true;
            });
            
            renderTable();
        }
        
        // Render table
        function renderTable() {
            const headers = resultsData.headers || [];
            const thead = document.getElementById('tableHeaders');
            const tbody = document.getElementById('tableBody');
            
            // Render headers
            thead.innerHTML = '';
            headers.forEach((header, idx) => {
                const th = document.createElement('th');
                th.className = 'sortable';
                th.textContent = header;
                th.onclick = () => sortTable(idx);
                
                if (sortColumn === idx) {
                    th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
                
                thead.appendChild(th);
            });
            
            // Add status column
            const statusTh = document.createElement('th');
            statusTh.textContent = 'Status';
            statusTh.className = 'sortable';
            statusTh.onclick = () => sortTable('status');
            if (sortColumn === 'status') {
                statusTh.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
            thead.appendChild(statusTh);
            
            // Render rows
            tbody.innerHTML = '';
            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = row.status || '';
                
                row.values.forEach(value => {
                    const td = document.createElement('td');
                    const displayValue = value !== null && value !== undefined ? value : '';
                    td.textContent = displayValue;
                    
                    // Style "error" values (measurement failures from SPICE)
                    if (displayValue === 'error') {
                        td.className = 'measurement-error';
                        td.title = 'Measurement failed during simulation (TRIG/TARG condition not met)';
                    }
                    
                    tr.appendChild(td);
                });
                
                // Status badge
                const statusTd = document.createElement('td');
                if (row.status) {
                    statusTd.innerHTML = `<span class="status-badge ${row.status}">${row.status}</span>`;
                }
                tr.appendChild(statusTd);
                
                tbody.appendChild(tr);
            });
        }
        
        // Sort table
        function sortTable(columnIdx) {
            if (sortColumn === columnIdx) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnIdx;
                sortDirection = 'asc';
            }
            
            filteredData.sort((a, b) => {
                let valA, valB;
                
                if (columnIdx === 'status') {
                    valA = a.status || '';
                    valB = b.status || '';
                } else {
                    valA = a.values[columnIdx];
                    valB = b.values[columnIdx];
                }
                
                // Try numeric comparison
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    return sortDirection === 'asc' ? numA - numB : numB - numA;
                }
                
                // String comparison
                const strA = String(valA || '').toLowerCase();
                const strB = String(valB || '').toLowerCase();
                
                if (sortDirection === 'asc') {
                    return strA.localeCompare(strB);
                } else {
                    return strB.localeCompare(strA);
                }
            });
            
            renderTable();
        }
        
        // Export to CSV
        function exportToCsv() {
            const headers = resultsData.headers || [];
            const allHeaders = [...headers, 'status'];
            
            let csv = allHeaders.join(',') + '\n';
            
            filteredData.forEach(row => {
                const values = [...row.values, row.status || ''];
                const escapedValues = values.map(val => {
                    const str = String(val !== null && val !== undefined ? val : '');
                    return str.includes(',') ? `"${str}"` : str;
                });
                csv += escapedValues.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `results_${getSimId()}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Spec Limits Modal Functions
        async function openSpecLimitsModal() {
            const modal = document.getElementById('spec-limits-modal');
            modal.classList.add('show');
            
            // Load current spec limits
            try {
                const response = await fetch('/api/spec-limits');
                const data = await response.json();
                
                // Populate form with current active values (custom or defaults)
                const active = data.active_limits || {};
                document.getElementById('rwkpull_vih_min').value = active.rwkpull_vih?.min || '';
                document.getElementById('rwkpull_vih_max').value = active.rwkpull_vih?.max || '';
                document.getElementById('rwkpull_vil_min').value = active.rwkpull_vil?.min || '';
                document.getElementById('rwkpull_vil_max').value = active.rwkpull_vil?.max || '';
                document.getElementById('rwkpulld_vih_min').value = active.rwkpulld_vih?.min || '';
                document.getElementById('rwkpulld_vih_max').value = active.rwkpulld_vih?.max || '';
                document.getElementById('rwkpulld_vil_min').value = active.rwkpulld_vil?.min || '';
                document.getElementById('rwkpulld_vil_max').value = active.rwkpulld_vil?.max || '';
                
                // Show status message
                const statusDiv = document.getElementById('spec-limits-status');
                if (data.using_custom) {
                    statusDiv.innerHTML = '<div class="success" style="margin-bottom: 15px;">‚úÖ Using custom spec limits</div>';
                } else {
                    statusDiv.innerHTML = '<div class="info" style="margin-bottom: 15px;">‚ÑπÔ∏è Using default spec limits</div>';
                }
            } catch (error) {
                console.error('Error loading spec limits:', error);
                document.getElementById('spec-limits-status').innerHTML = 
                    '<div class="error">‚ùå Error loading spec limits</div>';
            }
        }
        
        function closeSpecLimitsModal() {
            const modal = document.getElementById('spec-limits-modal');
            modal.classList.remove('show');
        }
        
        async function saveSpecLimits() {
            const statusDiv = document.getElementById('spec-limits-status');
            const saveBtn = document.getElementById('save-spec-limits-btn');
            
            // Collect values from form
            const specLimits = {
                rwkpull_vih: {
                    min: parseFloat(document.getElementById('rwkpull_vih_min').value) || null,
                    max: parseFloat(document.getElementById('rwkpull_vih_max').value) || null
                },
                rwkpull_vil: {
                    min: parseFloat(document.getElementById('rwkpull_vil_min').value) || null,
                    max: parseFloat(document.getElementById('rwkpull_vil_max').value) || null
                },
                rwkpulld_vih: {
                    min: parseFloat(document.getElementById('rwkpulld_vih_min').value) || null,
                    max: parseFloat(document.getElementById('rwkpulld_vih_max').value) || null
                },
                rwkpulld_vil: {
                    min: parseFloat(document.getElementById('rwkpulld_vil_min').value) || null,
                    max: parseFloat(document.getElementById('rwkpulld_vil_max').value) || null
                }
            };
            
            // Validate: min must be less than max
            for (const [param, limits] of Object.entries(specLimits)) {
                if (limits.min !== null && limits.max !== null && limits.min >= limits.max) {
                    statusDiv.innerHTML = `<div class="error">‚ùå Error: ${param} min must be less than max</div>`;
                    return;
                }
            }
            
            // Show loading state
            saveBtn.disabled = true;
            saveBtn.classList.add('loading');
            saveBtn.innerHTML = '<span class="spinner"></span> Saving...';
            
            // Save to backend
            try {
                const response = await fetch('/api/spec-limits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(specLimits)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="success">‚úÖ Spec limits saved successfully! Closing...</div>';
                    
                    // Keep loading state visible, close modal after brief delay
                    setTimeout(() => {
                        closeSpecLimitsModal();
                        loadResults();
                        // Reset button state after modal closes
                        saveBtn.disabled = false;
                        saveBtn.classList.remove('loading');
                        saveBtn.innerHTML = 'üíæ Save Changes';
                    }, 800);
                } else {
                    // Restore button on error
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('loading');
                    saveBtn.innerHTML = 'üíæ Save Changes';
                    statusDiv.innerHTML = `<div class="error">‚ùå Error: ${data.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                // Restore button on network error
                saveBtn.disabled = false;
                saveBtn.classList.remove('loading');
                saveBtn.innerHTML = 'üíæ Save Changes';
                statusDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }
        
        async function resetSpecLimits() {
            const statusDiv = document.getElementById('spec-limits-status');
            
            if (!confirm('Reset to default spec limits? This will delete all custom limits.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/spec-limits', {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="success">‚úÖ Reset to defaults successfully!</div>';
                    
                    // Reload the modal to show default values
                    setTimeout(() => {
                        closeSpecLimitsModal();
                        loadResults();
                    }, 1500);
                } else {
                    statusDiv.innerHTML = `<div class="error">‚ùå Error: ${data.detail || 'Unknown error'}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }
        
        // Event listeners
        document.getElementById('processFilter').addEventListener('change', applyFilters);
        document.getElementById('tempFilter').addEventListener('change', applyFilters);
        document.getElementById('voltageFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        
        // Load results on page load
        loadResults();
    </script>
</body>
</html>
